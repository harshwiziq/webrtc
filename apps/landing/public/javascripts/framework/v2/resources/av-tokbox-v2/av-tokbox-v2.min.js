define("container",["require","jquery","log"],function(e){function o(e){return this.mode}function u(e){if(i.indexOf(e)==-1){n.error("set_mode: unrecognized container mode : "+e);return}var r=t(this.div());for(var s=0;s<i.length;s++){var o="av-"+i[s];if(e==i[s]){r.hasClass(o)||r.addClass(o);continue}r.hasClass(o)&&r.removeClass(o)}n.info("set mode = "+e+", for #"+this.id()),this.mode=e}function a(e){return i.indexOf(e)==-1?(n.error("in_mode: unrecognized container mode : "+e),!1):this.mode==e}function f(){return this.type}function l(e){if(s.indexOf(e)===-1){n.error('set_type: unknown type "'+e+'" for container #'+this.id());return}this.type=e}function c(e){this.conn_id=e}function h(e,t){this.attrs[e]=t,n.info("container attribute set - key :"+e+"value :"+this.attrs[e])}function p(e){return this.attrs[e]}function d(e,t){w.call(this,"connected")}function v(){var e=t(this.div()),r=e.attr("class").split(/\s+/);t.each(r,function(t,n){if(n==="av-container")return;if(n==="tooltip")return;e.removeClass(n)}),e.hasClass("av-container")||e.addClass("av-container"),e.hasClass("av-shunya")||e.addClass("av-shunya"),this.mode="shunya",this.type=null,this.state="initial",this.conn_id=null,this.stream=null,n.info("gave up container "+this.id())}function m(e){t(this.div()).append("<span></span>"),t(this.div()).addClass("av-error");var n=t(this.div()).find("span");n.addClass("av-error"),this.state="error"}function g(){var e=t(this.div());e.hasClass("av-shunya")&&e.removeClass("av-shunya"),e.hasClass("av-visible")||e.addClass("av-visible")}function y(){var e=t(this.div());e.hasClass("av-visible")&&e.removeClass("av-visible"),e.hasClass("av-shunya")||e.addClass("av-shunya")}function b(e){var i=t(this.div());if(r.indexOf(e)==-1)return n.error("change_state: unrecognized container state ("+e+") requested"),!1;for(var s=0;s<r.length;s++){var o="av-"+r[s];if(e!=r[s]){i.hasClass(o)&&i.removeClass(o);continue}i.hasClass(o)||i.addClass(o)}return this.state=e,!0}function w(e){var t=this.state;b.call(this,e)&&(e!=="connected"&&e!=="streaming"||this.type==="audio-only"||this.type==="null"?y.call(this):g.call(this),n.info("[ #"+this.id()+' ]changed state from "'+t+'" to "'+e+'"'))}function E(){var e=this.div();return t(e).hasClass("av-primary")?!0:!1}function S(){w.call(this,"streaming")}function T(e,t){var n,r,i,s,o=0,u=0,a,f;e.push(t),e.length>x&&e.splice(0,1);if(!e.length)return{audio:"0%",audio_bw:"-",video:"0%",video_bw:"-"};var l=e.length-1,c=e[l].timestamp-e[0].timestamp;return e[0].audio&&e[l].audio?(n=e[l].audio.packetsLost-e[0].audio.packetsLost,r=e[l].audio.packetsReceived-e[0].audio.packetsReceived,r+n===0?a=0:a=(r*100/(r+n)).toFixed(1),o=(e[l].audio.bytesReceived-e[0].audio.bytesReceived)*8/c):a="-",e[0].video&&e[l].video?(i=e[0].video.packetsLost-e[l].video.packetsLost,s=e[0].video.packetsReceived-e[l].video.packetsReceived,s+i===0?f=0:f=(s*100/(s+i)).toFixed(1),u=(e[l].video.bytesReceived-e[0].video.bytesReceived)*8/c):f="-",{audio:a,audio_bw:c?o.toFixed(0):"-",video:f,video_bw:c?u.toFixed(0):"-"}}function N(e){if(!e)return;var n=this.div_,r=this.q,i=t(n).find(".tooltip-content");e.identity&&(t(i).find("span.name").html(e.identity.displayName),t(i).find("span.nickname").html(e.identity.nickname),t(i).find("span.vc_id").html(e.identity.vc_id)),"has_video"in e&&(e.has_video?(t(i).find("svg#camera").css("display","inline-block"),t(i).find("svg#camera-slash").css("display","none")):(t(i).find("svg#camera").css("display","none"),t(i).find("svg#camera-slash").css("display","inline-block"))),"has_audio"in e&&(e.has_audio?(t(i).find("svg#microphone").css("display","inline-block"),t(i).find("svg#microphone-slash").css("display","none"),t(n).find(".mic-indicator").removeClass("show-mute")):(t(i).find("svg#microphone").css("display","none"),t(i).find("svg#microphone-slash").css("display","inline-block"),t(n).find(".mic-indicator").addClass("show-mute")));if(e.subscriber_stats){var s=e.subscriber_stats,o=T(r,s);t(i).find("span.audio-loss").html(s.audio?s.audio.packetsLost:"-"),t(i).find("span.audio-rx").html(s.audio?s.audio.packetsReceived:"-"),t(i).find("span.audio-bw").html(o.audio_bw+" Kbps"),t(i).find("span.video-loss").html(s.video?s.video.packetsLost:"-"),t(i).find("span.video-rx").html(s.video?s.video.packetsReceived:"-"),t(i).find("span.video-bw").html(o.video_bw+" Kbps")}}var t=e("jquery"),n=e("log")("av-container","info"),r=["initial","connected","streaming","error"],i=["shunya","primary","secondary","screenshare","full","pip"],s=["video-primary","video-secondary","screenshare-local","screenshare-remote","audio-only","null"],x=5;return function(e){this.id_=t(e).attr("id"),this.div_=e,this.mode="shunya",this.type=null,this.state="initial",this.conn_id=null,this.stream=null,this.q=[],this.attrs={},this.div=function(){return this.div_},this.id=function(){return this.id_},this.set_type=l,this.get_type=f,this.set_mode=u,this.get_mode=o,this.in_mode=a,this.set_connection_id=c,this.stream_destroyed=d,this.giveup=v,this.show_error=m,this.change_state=w,this.in_mode_primary=E,this.reveal_video=S,this.set_meta=N,this.set_attribute=h,this.get_attribute=p}}),define("container-pool",["require","jquery","events","log","./container"],function(e){function l(e){t.each(t("#av-containers .av-container"),function(e,n){var s=t(n).attr("id"),o=free_video;Object.keys(free_screenshare).length||(o=free_screenshare),o[s]=new i(n),r.info('probe_layout: adding container "#'+s+'" to av pool')})}function h(e){if(!u)return"container template not found";c++;var n="av-container-"+c,r=u({cont_id:n});t("#av-containers").append(r);var s=t("#"+n)[0];return new i(s)}var t=e("jquery"),n=e("events"),r=e("log")("av-container-pool","info"),i=e("./container"),s={},o,u,a={},f=n.emitter("av:containers","av:container-pool.js");s.init=function(e,t,n,r){return u=e.template("container"),o=t.anchor,!0},s.alloc_container=function(e,t,n){var i=h(e);i.set_type(e),i.set_mode(t),i.set_meta(n),i.change_state("connected");var o=i.div().id;return a[o]=i,f.emit("allocated",{type:e,mode:t,visible_conts:s.get_num_visible_containers(),meta:n}),r.info("allocated container #"+o+", type ("+e+"), mode ("+t+")"),i},s.giveup_container=function(e){var t=e.id(),n=e.get_type();if(!a[t]){r.error("attempt to giveup non-used container (id = #"+t+")");return}delete a[t],f.emit("de-allocated",{type:e.type,mode:e.mode,visible_conts:s.get_num_visible_containers()}),e.giveup()},s.get_containers_by_type=function(e){var t=[];for(var n in a){var r=a[n];r.get_type()==e&&t.push(r)}return t},s.get_containers_by_mode=function(e){var t=[];for(var n in a){var r=a[n];r.get_mode()==e&&t.push(r)}return t},s.free_count=function(e){return 0},s.get_container_by_id=function(e,t){if(e!="used"&&!0)throw"pool.get_container_by_id: invalid argument (pool = "+e+")";if(e==="used")return a[t]},s.get_used_list=function(){var e=[];for(var t in a)e.push(a[t]);return e},s.get_containers_by_type=function(e){var t=[];for(var n in a){var r=a[n];r.get_type()==e&&t.push(r)}return t},s.get_num_visible_containers=function(){return s.get_used_list().length-s.get_containers_by_type("audio-only").length-s.get_containers_by_type("null").length};var c=0;return s}),define("menu",["require","jquery","log"],function(e){function h(e){var t=e==="video"?"camera":"microphone";if(!o("av-"+t,"turn-on"))return;var i="mute";switch(c[e]){case"off-disabled":r.av_controls.change_state(t,"off-enabled");break;case"busy-disabled":case"off-enabled":case"on-enabled":break;default:n.error("Unknown state of "+e+", state : "+c[e])}}function p(e){var t=e==="video"?"camera":"microphone",i="mute";switch(c[e]){case"off-disabled":case"busy-disabled":break;case"off-enabled":r.av_controls.change_state(t,"off-disabled");break;case"on-enabled":break;default:n.error("Unknown state of "+e+", state : "+c[e])}}var t=e("jquery"),n=e("log")("av-menu","info"),r={},i,s,o;r.init=function(e,n){return i=e,s=n,o=i.perms.has_perm,t("#widget-nav .av-menu-item").on("click",r.av_controls.fire),null};var u=null,a=!1;r.screenshare={set_handler:function(e){u=e,a=!0,t("#widget-nav li#nav-screenshare a").on("click",e),t("#widget-nav li#nav-screenshare").removeClass("disabled")},enable:function(){if(u){if(a)return;t("#widget-nav li#nav-screenshare a").on("click",u),t("#widget-nav li#nav-screenshare").removeClass("disabled")}},disable:function(){a=!1,t("#widget-nav li#nav-screenshare a").off("click"),t("#widget-nav li#nav-screenshare").addClass("disabled")}};var f=null,l="unmute";r.local_media_changed=function(e,n){var r=e==="camera"?"video":"audio",i=n?"unmute":"mute",s=n?"mute":"unmute";t("#av-menu-"+r+"-"+i).css("display","inline-block"),t("#av-menu-"+r+"-"+s).css("display","none")};var c={};return c.audio="off-disabled",c.video="off-disabled",r.av_controls={set_handler:function(e){if(f)throw"menu.av_controls : duplicate handler registered";f=e,o("av-microphone","mute")||(t("#av-menu-audio-mute").addClass("read-only"),t("#av-menu-audio-unmute").addClass("read-only")),o("av-camera","disable")||(t("#av-menu-video-mute").addClass("read-only"),t("#av-menu-video-unmute").addClass("read-only")),t(".av-menu-item").removeClass("disabled")},fire:function(e){curr_target=t(e.currentTarget).attr("id");if(!f)return;if(t(e.currentTarget).closest("li").hasClass("disabled"))return;if(t(e.currentTarget).hasClass("read_only"))return;var r=curr_target.replace(/^av-menu-([^-]+)-.*$/g,"$1"),i=curr_target.replace(/^.*-([^-]*mute)$/g,"$1"),s=i==="mute"?"unmute":"mute",u,a;switch(r){case"audio":u="av-microphone",a="mute";break;case"video":u="av-camera",a="disable";break;default:n.error("invalid target type = "+r+", for action: "+s);return}if(!o(u,a)){n.log({res:u,op:a},"permission denied");return}var l=t.Deferred();f(l,r,s);return},manage:function(e,t){if(t){h(e);return}p(e)},change_state:function(e,i){var s=e==="camera"?"video":"audio",o=c[s],u="mute";n.info("Change state. Old state : "+o+", new state : "+i);switch(o){case"off-disabled":switch(i){case"off-disabled":break;case"busy-disabled":t("#av-menu-"+s+"-"+u).closest("li").addClass("busy"),c[s]=i;break;case"off-enabled":t("#av-menu-"+s+"-"+u).closest("li").removeClass("disabled"),c[s]=i;break;case"on-enabled":t("#av-menu-"+s+"-"+u).closest("li").removeClass("disabled"),r.local_media_changed(e,!0),c[s]=i}break;case"busy-disabled":switch(i){case"off-disabled":t("#av-menu-"+s+"-"+u).closest("li").removeClass("busy"),c[s]=i;break;case"busy-disabled":break;case"off-enabled":t("#av-menu-"+s+"-"+u).closest("li").removeClass("busy"),t("#av-menu-"+s+"-"+u).closest("li").removeClass("disabled"),c[s]=i;break;case"on-enabled":t("#av-menu-"+s+"-"+u).closest("li").removeClass("busy"),t("#av-menu-"+s+"-"+u).closest("li").removeClass("disabled"),r.local_media_changed(e,!0),c[s]=i}break;case"off-enabled":switch(i){case"off-disabled":t("#av-menu-"+s+"-"+u).closest("li").addClass("disabled"),c[s]=i;break;case"busy-disabled":t("#av-menu-"+s+"-"+u).closest("li").addClass("busy"),t("#av-menu-"+s+"-"+u).closest("li").addClass("disabled"),c[s]=i;break;case"off-enabled":break;case"on-enabled":r.local_media_changed(e,!0),c[s]=i}break;case"on-enabled":switch(i){case"off-disabled":n.error("Not a possible state transition of button. Old state : "+o+", new state : "+i);break;case"busy-disabled":t("#av-menu-"+s+"-"+u).closest("li").addClass("busy"),t("#av-menu-"+s+"-"+u).closest("li").addClass("disabled"),r.local_media_changed(e,!1),c[s]=i;break;case"off-enabled":n.error("Not a possible state transition of button. Old state : "+o+", new state : "+i);break;case"on-enabled":}}return},change_state_conditionally:function(e,t){e.audio&&r.av_controls.change_state("microphone",t),e.video&&r.av_controls.change_state("camera",t);return}},r}),define("layout",["require","jquery","events","log","./container","./container-pool","./menu"],function(e){function d(e){var t=s.get_containers_by_mode(e);t.length||(r.info("No video of mode : "+e+"as of now. Looking for secondary containers"),t=s.get_containers_by_mode("secondary")),u.set_container_properties(t[0],"video-secondary");return}function v(e){var t,n=!1;for(var i=0;i<e.length;i++){t=e[i];if(t.attrs.stream_type==="local")continue;t.set_type("video-primary"),r.info("secondary container set as primary. cont.conn_id"+t.conn_id),n=!0;break}if(n)return;e[0].set_type("video-primary");return}function m(e,n){t.each(t("#av-containers .av-container"),function(e,s){var o=t(s).attr("id");n[o]=new i(s),r.info('probe_layout: adding container "#'+o+'" to av pool')})}function g(e,n){if(!u.get_num_visible_containers()){t(".av-initial .av-background").css("display","block");return}t(".av-initial .av-background").css("display","none")}function y(){n.bind("framework:layout",N,"av-layout"),n.bind("av:connection",T,"av-layout"),n.bind("av:containers",g,"av-layout"),t("#av-containers").on("click",".av-container",function(e){var n=e.currentTarget,i=t(n).attr("id"),o=s.get_container_by_id("used",i);if(!o){r.error("clicked_container is null. Ignoring click.");return}b(o)})}function b(e){switch(p){case"av-default":w(e);break;case"av-fullscreen":E(e);break;case"av-tiled":break;default:r.error('unknown layout "'+p+'". Handling as default.'),w(e)}}function w(e){var t,n;if(e.in_mode("screenshare")){t=s.get_containers_by_mode("primary"),e.set_mode("full"),t.length&&t[0].set_mode("pip");return}if(e.in_mode("secondary")){t=s.get_containers_by_mode("primary")[0],t.set_mode("secondary"),e.set_mode("primary");return}if(e.in_mode("full")){n=s.get_containers_by_mode("pip")[0],n.set_mode("primary"),e.set_mode("screenshare");return}}function E(e){var t,n;if(e.in_mode("secondary")){t=s.get_containers_by_mode("primary")[0],e.set_mode("primary"),t.set_mode("secondary");return}}function S(e,t){var n;switch(e){case"av-fullscreen":n={"video-primary":"primary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"secondary","audio-only":"shunya","null":"shunya"};break;case"av-tiled":n={"video-primary":"secondary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"secondary","audio-only":"shunya","null":"shunya"};break;case"av-default":n={"video-primary":"primary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"screenshare","audio-only":"shunya","null":"shunya"};break;default:n={"video-primary":"primary","video-secondary":"secondary","screenshare-local":"secondary","screenshare-remote":"screenshare","audio-only":"shunya","null":"shunya"}}return n[t]}function T(e,t){}function N(e,t){var n=e;switch(n){case"av-default":k();break;default:C(n)}p=n;return}function C(e){s.get_used_list().forEach(function(t,n,r){var i=t.get_mode(),s=t.get_type(),o=S(e,s);o!=i&&t.set_mode(o)})}function k(){var e=s.get_containers_by_type("screenshare-remote"),t=s.get_containers_by_type("video-primary");C("av-default"),e.length&&(e[0].set_mode("full"),t.length&&t[0].set_mode("pip"))}var t=e("jquery"),n=e("events"),r=e("log")("av-layout","info"),i=e("./container"),s=e("./container-pool"),o=e("./menu"),u={},a,f,l,c={},h={},p="av-default";u.init=function(e,n,r,i){var s="av-tokbox",o=e.template(s);return f=n.anchor,l=e.perms.has_perm,o?(t(f).append(o()),y(),null):'av-layout: template "'+s+'" not found'},u.get_container=function(e,t){var n=S(p,e);e==="screenshare-local"&&(primary=s.get_containers_by_mode("primary"),primary.length===0&&(n="primary"));var i=s.alloc_container(e,n,t);return e==="screenshare-remote"&&(b(i),s.free_count("screenshare")||(o.screenshare.disable(),r.info("cpool not free"))),i},u.giveup_container=function(e,t){var n=e.get_type();s.giveup_container(e),u.adjust();var r=l("write","control");n==="screenshare-remote"&&r&&o.screenshare.enable();return},u.show_error=function(e,t){return e.show_error(t)},u.stream_destroyed=function(e,t){e.stream_destroyed(t)},u.reveal_video=function(e){e.reveal_video()},u.get_initial_container_type=function(e){return e.video?u.get_container_type_conditionally(null,!0):e.audio?"audio-only":null},u.is_primary_vid_free=function(){return s.get_containers_by_mode("primary").length===0?(r.info("no primary video present"),!0):!1},u.get_container_type_conditionally=function(e,t,n){var i=s.get_num_visible_containers(),o;switch(i){case 0:o="video-primary";break;case 1:if(t){o="video-secondary";break}d("primary"),o="video-primary";break;default:var u=null,a=s.get_containers_by_type("video-primary");a.length&&(u=a[0].get_attribute("stream_type")||null);if(u=="local"){r.info("Primary container contains local stream. Replace it with incoming stream"),d(a[0].get_mode()),o="video-primary";break}if(e&&n&&!t){r.info("Set incoming stream as primary. Replace primary with incoming stream"),d(a[0].get_mode()),o="video-primary";break}r.info("Set incoming stream as a secondary one"),o="video-secondary"}return o},u.adjust=function(){var e=s.get_num_visible_containers(),t,n,i;switch(e){case 0:break;case 1:i=s.get_containers_by_mode("secondary");if(i.length===0)break;n=i[0],n.set_type("video-primary");break;default:if(s.get_containers_by_mode("primary").length>0||s.get_containers_by_mode("pip").length>0){r.info("No layout management needed since there is a primary container");break}i=s.get_containers_by_mode("secondary"),v(i)}N(p,null);return},u.set_container_properties=function(e,t){e.set_type(t),e.set_mode(S(p,t));return},u.get_num_visible_containers=function(){return s.get_num_visible_containers()};var x=0;return u}),define("tokbox",["require","//tokbox.com/v2/js/opentok.min.js","log","jquery"],function(e,t,n,r){function f(e,t){if(typeof e=="string")return(t?t+"-":"")+e;switch(e.code){case 1500:e.message="permission denied. Enable the webcam and microphone and load the page again.";break;default:}return(t?t+" - ":"")+e.message+" (code = "+e.code+")"}function h(e){if(!l)return i.error("exception: ("+e.code+")"+e.title+": "+e.message);l(e.code,e.title,e.message)}function d(e,t){p[e]=t}function v(e){delete p[e]}var i=n("av-tokbox","info"),s=window.OT,o={},u,a;s.on("exception",h),o.init=function(e){var t=r.Deferred();return s.checkSystemRequirements()===0?(t.reject("OT: no WebRTC support. Aborting."),t.promise()):(u=s.initSession(e.key,e.sessionid),u.off(),t.resolve(e),t.promise())},o.set_handlers=function(e,t){var n=r.Deferred();return u.on({sessionConnected:e.sessionConnected,sessionConnectFailed:e.sessionConnectFailed,sessionDisconnected:e.sessionDisconnected,sessionReconnecting:e.sessionReconnecting,sessionReconnected:e.sessionReconnected,connectionCreated:function(t){var n=t.connection,r=n.connectionId,s=n.data;d(r,n);var o=r==u.connection.connectionId?!0:!1;i.info("connection created: "+r+" (local = "+o+"), data: "+n.data),e.connectionCreated(r,s,o)},connectionDestroyed:function(t){var n=t.connection,r=n.connectionId;i.info("connection destroyed: "+r+", reason: "+t.reason),v(r),e.connectionDestroyed(r,t.reason)},streamCreated:function(t){var n=t.stream,r=n.streamId,s=n.connection.connectionId;i.info("stream created: (conn_id = "+s+")"+r+", type: "+n.videoType+", stream: ",n),e.streamCreated(r,n)},streamDestroyed:function(t){var n=t.stream,r=n.streamId;i.info("stream destroyed: "+r+", reason: "+t.reason),e.streamDestroyed(r,t.reason)},streamPropertyChanged:function(t){var n=t.changedProperty,r=t.oldValue,i=t.newValue,s=t.stream.streamId;e.streamPropertyChanged(s,t.stream,n,r,i)}}),n.resolve(t),n.promise()},o.connect=function(e){var t=e.token,n=r.Deferred();return u.connect(t,function(t){if(t)return n.reject(f(t,"connect"));n.resolve(e)}),n.promise()},o.init_publisher=function(e,t,n,o){var u=r.Deferred();n||i.error("no div supplied !");var l=!0,c=!0;t&&t.on_startup&&(l=t.on_startup.video?!0:!1,c=t.on_startup.audio?!0:!1),i.info("publisher config "+l+" "+c);var h={width:"100%",height:"100%",audioFallbackEnabled:!0,fitMode:"cover",frameRate:30,insertMode:"append",maxResolution:{width:1280,height:720},name:e,publishAudio:c,publishVideo:l,resolution:o&&o.resolution||"320x240",showControls:!1,style:{audioLevelDisplayMode:"off",backgroundImageURI:"off",nameDisplayMode:"off",buttonDisplayMode:"off"}},p=!t||Object.keys(t).length===0?o:h;return a=s.initPublisher(n,p,function(e){return e?u.reject(f(e,"webcam")):u.resolve(t,a)}),r(n).attr("style",""),u.promise()},o.publish=function(e){var t=r.Deferred();return e||(e=a),u.publish(e,function(n){if(n)return i.error("publish: err = "+f(n)),t.reject(f(n));t.resolve(e)}),t.promise()};var l;o.set_exception_handler=function(e){l=e},o.set_pub_handlers=function(e){for(var t in e)a.on(t,e[t])},o.subscribe=function(e,t,n){var s=r.Deferred();t||i.error("no div supplied !");var o={style:{nameDisplayMode:"off",buttonDisplayMode:"off",videoDisabledDisplayMode:"auto",audioLevelDisplayMode:"off"},fitmode:"cover",insertMode:"append",width:"100%",height:"100%"},a=u.subscribe(e,t,o,function(e){if(e)return s.reject(f(e));s.resolve(a)});return s.promise()},o.checkScreenSharingCapability=s.checkScreenSharingCapability,o.registerScreenSharingExtension=s.registerScreenSharingExtension;var c={1004:"Authentication error",1005:"Invalid Session ID",1006:"Connect Failed",1007:"Connect Rejected",1008:"Connect Time-out",1009:"Security Error",1010:"Not Connected",1011:"Invalid Parameter",1013:"Connection Failed",1014:"API Response Failure",1026:"Terms of Service Violation: Export Compliance",1500:"Unable to Publish",1520:"Unable to Force Disconnect",1530:"Unable to Force Unpublish",1535:"Force Unpublish on Invalid Stream",2e3:"Internal Error",2010:"Report Issue Failure"},p={};return o}),define("local-media",["require","jquery","log","./layout","./tokbox","./container","./menu"],function(e){function h(e,t){i.set_pub_handlers({accessAllowed:p,accessDenied:d,accessDialogOpened:v,accessDialogClosed:m,destroyed:g,mediaStopped:y,streamCreated:b,streamDestroyed:w}),e.resolve(t)}function p(e){}function d(e){n.error("it seems, access to local media was denied by the user. TODO: Show a modal error here.")}function v(e){}function m(e){}function g(e){n.info("publisher element destroyed: reason: "+e.reason)}function y(e){}function b(e){var t=e.stream;t.hasVideo&&r.reveal_video(f);var n={};n.audio=t.hasAudio,n.video=t.hasVideo,o.av_controls.change_state_conditionally(n,"on-enabled"),l.emit("incoming-media",{connection_id:"local-media",stream_id:t.streamId,stream:t})}function w(e){n.info("streamDestroyed: ev = ",e),r.stream_destroyed(f,e.reason)}function E(e,t){var n={vc_id:c.identity.vc_id,on_startup:e,status:t};c.send_info(null,"av-startup-confirm",n,0)}var t=e("jquery"),n=e("log")("av-local","info"),r=e("./layout"),i=e("./tokbox"),s=e("./container"),o=e("./menu"),u={},a,f,l,c;return u.init=function(e,n,r,s){var o=t.Deferred(),u=e.identity.vc_id;c=e,f=n,l=r,t(f.div()).append('<div id="av-ot-localmedia-wrap"></div>');var p=t("div#av-ot-localmedia-wrap");return i.init_publisher(u,s,p[0]).then(function(e,t){a=t,h(o,s)},o.reject.bind(o)),o.promise()},u.start=function(e){var n=t.Deferred(),r=e.on_startup;return i.publish().then(function(){return f.set_meta({identity:c.identity,has_video:r.video,has_audio:r.audio}),E(r,"success"),n.resolve(e)},function(e){return a=null,E(r,"failure"),n.reject(e)}),n.promise()},u.container=function(){return f},u.set_meta=function(e,t){if(e==="audio"){f.set_meta({has_audio:t==="mute"?!1:!0});return}f.set_meta({has_audio:t==="mute"?!1:!0});return},u.publisher_controls=function(e,t){switch(e){case"audio":a.publishAudio(t==="mute"?!1:!0),f.set_meta({has_audio:t==="mute"?!1:!0});break;case"video":a.publishVideo(t==="mute"?!1:!0),f.set_meta({has_video:t==="mute"?!1:!0});break;default:n.error("invalid element type = "+e+", for action: "+t)}},u.has_publisher=function(){return a?!0:!1},u}),define("session",["require","jquery","events","log","./local-media","./layout","./tokbox","./menu","urls"],function(e){function w(e,n,o){var f=t.Deferred(),l=e.on_startup;if(o&&!l.audio&&!l.video)return r.info("A/V does not have to be started as per startup config"),f.resolve("No need to start av"),f.promise();u.av_controls.change_state_conditionally(l,"busy-disabled");var h=s.get_initial_container_type(l);if(!h)return r.info("Can not allocate a container for A/V as per startup conditions"),f.reject("No container available"),f.promise();var p=a.params("av_publish");if(p&&p==="false")return r.info("I am the recbot"),f.resolve(),f.promise();var d=s.get_container(h);return d.set_attribute("stream_type","local"),i.init(c,d,n,e).then(i.start,f.reject.bind(f)).then(f.resolve.bind(f),f.reject.bind(f)),f.promise()}function E(e,t,n){c.alerts.open({level:"alert-danger",dismiss:!0,refresh:!0,model:'<span style="font-weight:bold;">'+t+"</span><span>&nbsp:&nbsp"+n+"</span>"})}function S(e){r.info("TODO : sessionConnected:",e)}function x(e){r.error("TODO : sessionConnectFailed:",e),c.alerts.open({level:"alert-danger",dismiss:!0,refresh:!0,model:e.message+"("+e.code+")"})}function T(e){c.alerts.open({level:"alert-danger",dismiss:!0,refresh:!0,model:e.message+"("+e.code+")"})}function N(e){r.info("TODO : sessionReconnected",e)}function C(e){r.info("TODO : sessionConnected",e)}function k(e,t,n){var r,i=JSON.parse(t);y[e]||(y[e]={streams:{}}),n||(n=!1),y[e].local=n,y[e].vc_id=i.vc_id,y[e].primary=i.is_primary,p.emit("incoming-connection",{connection_id:e,vc_id:i.vc_id,local:n});if(y[e].pending){for(var s in y[e].pending){var o=y[e].pending[s];A(s,o)}delete y[e].pending}}function L(e,t){if(!y[e]){r.error("connectionDestroyed: no mapping for connection id "+e+" (reason = "+t+")");return}r.info("connection destroyed: "+e+", reason = "+t);for(var n in y[e].streams){var i=y[e].streams[n];D(n,i)}delete y[e]}function A(e,t){var n={},i=t.connection.connectionId;if(!y[i]){r.info('race-condition: "streamCreated" called before "connectionCreated". Handling it.'),y[i].pending||(y[i]={pending:{}}),y[i].pending[e]=t;return}var u=y[i].local,a=O(t,u),f=y[i].vc_id,l=c.attendees.get_identity(f),h={identity:l,stream_id:e,has_video:t.hasVideo,has_audio:t.hasAudio};c.attendees.set_meta(f,"microphone",t.hasAudio),c.attendees.set_meta(f,"camera",t.hasVideo);var d=s.get_container(a,h);if(!d){c.alerts.open({level:"alert-danger",dismiss:!0,refresh:!0,model:"Internal error : Ran out of containers"});return}d.set_connection_id(i),b[e]={connection_id:i},y[i].streams[e]={stream:t,container:d,timer:null},o.subscribe(t,d.div(),n).then(function(n){d.set_attribute("stream_type","remote"),t.hasVideo&&s.reveal_video(d),p.emit("incoming-media",{connection_id:i,stream_id:e,stream:t}),b[e].timer=setInterval(B.bind(null,n,d),1e3),M[f]={ts:Date.now(),level:0},n.on("audioLevelUpdated",function(e){_(f,e.audioLevel)})},function(e){s.show_error(d,e),p.emit("incoming-media",{err:e,connection_id:i})})}function O(e,t){var n;switch(e.videoType){case"screen":n=t?"screenshare-local":"screenshare-remote";break;case"camera":if(e.hasVideo){n=s.get_container_type_conditionally(e,t,j(e));break}n="audio-only";break;default:r.error('Unknown stream type "'+e.videoType+'", conn_id: '+connection_id+", stream_id: "+stream_id),n="video-secondary"}return n}function _(e,t){var n=Date.now();M[e].level=t;if(n-M[e].ts<g)return;M[e].ts=n,c.attendees.set_meta(e,"audio-level",t)}function D(e,t){if(!b[e])return;var n=b[e].connection_id,i=y[n].streams[e].container;r.info("stream destroyed: stream_id: "+e+", reason = "+t),s.giveup_container(i,t),clearInterval(b[e].timer),delete y[n].streams[e],delete b[e]}function P(e,t,n,o,a){var f,l,h={},p=t.connection.connectionId,d=y[p].local,m=y[p].vc_id;try{f=d?i.container():y[p].streams[e].container}catch(g){r.error("streamPropertyChanged, caught an exception",g),f=null}r.info("stream property changed: "+e+", property: "+n+", changed from ("+o+") --> ("+a+")");switch(n){case"hasAudio":l="microphone",h.has_audio=a;break;case"hasVideo":l="camera",h.has_video=a}H(t,f,n,o,a),c.attendees.set_meta(m,l,a),f&&f.set_meta(h);if(d){var b=a===!0?"on-enabled":"off-enabled";u.av_controls.change_state(l,b)}v.emit("stream-property-changed",{type:f.type,mode:f.mode,visible_conts:s.get_num_visible_containers(),meta:h});if(d){var w={vc_id:m,property:n==="hasAudio"?"audio":"video",is_set:a===!0?!0:!1};c.send_info(null,"stream-property-changed",w,0)}}function H(e,t,n,i,o){switch(n){case"hasAudio":switch(o){case!0:if(!e.hasVideo){s.set_container_properties(t,"audio-only");break}r.info("Property changed : audio  new value :  true");break;case!1:e.hasVideo||s.set_container_properties(t,"null")}break;case"hasVideo":switch(o){case!0:var u=t.get_attribute("stream_type")=="local"?!0:!1,a=s.get_container_type_conditionally(e,u,j(e));s.set_container_properties(t,a),s.reveal_video(t);break;case!1:e.hasAudio?s.set_container_properties(t,"audio-only"):s.set_container_properties(t,"null"),s.adjust()}}}function B(e,t){e.getStats(function(e,n){t.set_meta({subscriber_err:e,subscriber_stats:n})})}function j(e){var t=e.connection.connectionId;return y[t].primary?!0:!1}var t=e("jquery"),n=e("events"),r=e("log")("av-session","info"),i=e("./local-media"),s=e("./layout"),o=e("./tokbox"),u=e("./menu"),a=e("urls"),f={},l,c,h={sessionConnected:S,sessionConnectFailed:x,sessionDisconnected:T,sessionReconnecting:N,sessionReconnected:C,connectionCreated:k,connectionDestroyed:L,streamCreated:A,streamDestroyed:D,streamPropertyChanged:P},p=n.emitter("av:connection","av:session.js"),d=n.emitter("av:stream","av:session.js"),v=n.emitter("av:containers","av:session.js"),m=n.emitter("av:channel","av:session.js"),g=500;f.init=function(e,t,n){return o.set_exception_handler(E),null},f.start=function(e,n){function s(e){return c.alerts.open({level:"alert-danger",dismiss:!0,refresh:!0,model:e}),this.reject(e)}var i=t.Deferred();return l=n,c=e,n.on_startup?(o.init(n).then(o.set_handlers.bind(o,h),s.bind(i)).then(o.connect,s.bind(i)).then(function(e){u.av_controls.set_handler(f.manage_publisher),w(n,p,!0).then(function(e){i.resolve(e)},function(e){u.av_controls.change_state_conditionally(n.on_startup,"off-disabled"),i.reject(e)})},s.bind(i,err)),i.promise()):(r.error("Can not find AV startup config in sess info"),i.reject({err:"no a/v startup config"}),i.promise())},f.info=function(e,t,n){r.info("from "+e+", info_id : "+t+", data : "+n);switch(t){case"channel-status":var i=n.free_audio_channels>0?!0:!1,s=n.free_video_channels>0?!0:!1;u.av_controls.manage("audio",i),u.av_controls.manage("video",s),m.emit(t,n),r.info('Event emitted in "av:channel" namespace : '+t);break;default:r.error("received unknown info_id ("+t+"). Ignoring.");return}},f.manage_publisher=function(e,t,n){if(i.has_publisher()){var r=t==="video"?"camera":"microphone";u.av_controls.change_state(r,"busy-disabled"),i.publisher_controls(t,n),e.resolve("done");return}var s={};s.on_startup={},s.on_startup.audio=t==="audio"?!0:!1,s.on_startup.video=t==="video"?!0:!1,w(s,p,!1).then(function(r){i.set_meta(t,n),e.resolve("done");return},function(t){u.av_controls.change_state_conditionally(s.on_startup,"off-disabled"),e.reject(t);return})};var y={},b={},M={};return f}),define("utils",["require","log"],function(e){function r(e,t,n){var r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)}var t=e("log")("av-utils","info"),n={};return n.detect_browser=function(){var e={};e.browser=null,e.version=null,e.minVersion=null;if(typeof window=="undefined"||!window.navigator)return e.browser="Not a browser.",e;if(navigator.mozGetUserMedia)return e.browser="firefox",e.version=r(navigator.userAgent,/Firefox\/([0-9]+)\./,1),e.minVersion=31,e;if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)e.browser="chrome",e.version=r(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),e.minVersion=38;else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return e.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",e;e.browser="safari",e.version=r(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1),e.minVersion=602}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return e.browser="Not a supported browser.",e;e.browser="edge",e.version=r(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2),e.minVersion=10547}return e.version<e.minVersion&&t.info("Browser: "+e.browser+" Version: "+e.version+" < minimum supported version: "+e.minVersion+"\n some things might not work!"),e},n}),define("screenshare",["require","jquery","log","./layout","remodal","./menu","./tokbox","./utils"],function(e){function p(){var e=t.Deferred();if(d())return e.resolve("Screen Sharing stopped"),e.promise();var r=u.detect_browser();return r&&r.browser&&r.browser==="firefox"?(g(r).then(function(){return e.resolve()},function(t){return n.error("err: ",t),e.reject(t)}),e.promise()):(o.registerScreenSharingExtension("chrome",l.chromeextensionid),v().then(y.bind(null,e,"chrome"),b.bind(null,e)),e.promise())}function d(e){return c?(n.info("Stopping screen share"),c.destroy(),c.emit("streamDestroyed",{reason:e||"User stopped screen share"}),!0):!1}function v(){var e=t.Deferred();return o.checkScreenSharingCapability(function(t){return!t.supported||t.extensionRegistered===!1?e.reject("screensharing not supported"):t.extensionInstalled===!1?e.resolve(!1):e.resolve(!0)}),e.promise()}function m(){var e=t.Deferred(),i=f.identity.vc_id;h=r.get_container("screenshare-local");if(!h)return f.notify.alert("Screenshare Error","Ran out of free containers","danger",{non_dismissable:!1,button:{}}),e.reject("ran out of free containers !"),e.promise();h.set_meta({identity:f.identity,has_video:!0,has_audio:!1}),t(h.div()).append('<div id="av-ot-screenshare-wrap"></div>');var s=t("div#av-ot-screenshare-wrap");return o.init_publisher(i,null,s[0],{videoSource:"screen"}).then(function(t,n){return c=n,N(),o.publish(c),r.reveal_video(h),h.set_attribute("stream_type","local"),e.resolve()},function(i){return f.alerts.open({level:"alert-warning",dismiss:!0,auto_dismiss:!0,model:"Screenshare : "+i}),t(h.div()).find("div#av-ot-screenshare-wrap").remove(),r.giveup_container(h),h=null,n.error("screenshare: failed to initialize publisher: ",i),e.reject(i)}),e.promise()}function g(e){var r=t.Deferred();return n.info("res: ",JSON.stringify(e)),e.version<38?(alert("older firefox version running. Update to latest version for screenshare"),r.reject("older firefox version running"),r.promise()):(v().then(y.bind(null,r,"firefox"),b.bind(null,r)),r.promise())}function y(e,t,r){return n.info("extension_installed : "+r),r?(m().then(function(){return n.info("screenshare started"),e.resolve()},function(t){return e.reject(t)}),e.promise()):(x(t),e.reject("Extension needs to be installed"))}function b(e,t){return f.notify.alert("Screenshare Error",t,"danger",{non_dismissable:!0,button:{}}),e.reject(t)}function w(){return"https://addons.mozilla.org/en-US/firefox/addon/screenshare-wiziq-vc/"}function E(){return"https://chrome.google.com/webstore/detail/"+l.chromeextensionid}function x(e){var n;switch(e){case"firefox":n=w();break;case"chrome":n=E();break;default:}S=t("[data-remodal-id=browser-extension-download]").remodal({closeOnConfirm:!1}),t("a[href='chromeSSExtPath']").attr("href",n),S.open()}function T(){S.close()}function N(){o.set_pub_handlers({accessAllowed:C,accessDenied:k,accessDialogOpened:L,accessDialogClosed:A,destroyed:O,mediaStopped:M,streamCreated:_,streamDestroyed:D})}function C(e){n.info("ss accessAllowed")}function k(e){n.error("it seems, access to local media was denied by the user. TODO: Show a modal error here.")}function L(e){n.info("ss accessDialogOpened")}function A(e){n.info("ss accessDialogClosed")}function O(e){n.info("publisher element destroyed: reason: "+e.reason)}function M(e){n.info("mediaStopped")}function _(e){var i=t("#widget-nav li#nav-screenshare");i.hasClass("enabled")||i.addClass("enabled");var s=i.find(".tooltip-content");s.text("Stop Screenshare"),n.info("ss streamCreated: ev = ",e);var o=e.stream;r.reveal_video(h)}function D(e){var i=t("#widget-nav li#nav-screenshare");i.hasClass("enabled")&&i.removeClass("enabled");var s=i.find(".tooltip-content");s.text("Screenshare"),n.info("streamDestroyed: ev = ",e),r.giveup_container(h,e.reason),c=null}var t=e("jquery"),n=e("log")("av-screenshare","info"),r=e("./layout"),i=e("remodal"),s=e("./menu"),o=e("./tokbox"),u=e("./utils"),a={},f,l,c,h;a.init=function(e,n){return f=e,l=n,t("div#av-modal .remodal-confirm").click(T),s.screenshare.set_handler(p),null},a.stop=d;var S;return a}),define("av-events",["require","jquery","events","log"],function(e){function u(e,t){switch(e){case"av":a(t);break;default:}}function a(e){var t=e.key,n=e.value,r=e.vc_id,i=s.identity.am_i(r);if(!i)return f(r,t,n?"unmute":"mute")}function f(e,t,n){s.send_command(e,t,n).then(function(){r.info('remote command "'+t+"->"+n+'" ok')},function(e){r.error('remote command "'+t+"->"+n+'" failed: reason: '+e)})}var t=e("jquery"),n=e("events"),r=e("log")("av-events","info"),i={},s,o;return i.init=function(e,t){return s=e,o=t,n.bind("framework:attendees",u,"av-tokbox"),null},i}),define("av-tokbox-v2",["require","jquery","jade","log","events","framework","./session","./layout","./screenshare","./local-media","./menu","./av-events","./container-pool"],function(e){function d(e,t){if(e!=="override")return;if(t.key==="write"&&t.subkey==="control"){var n=t.val?"enable":"disable";if(n==="disable"){var r="Taken write control back!";u.stop(r)}f.screenshare[n]()}}var t=e("jquery");window.jade=e("jade");var n=e("log")("av-main","info"),r=e("events"),i=e("framework"),s=e("./session"),o=e("./layout"),u=e("./screenshare"),a=e("./local-media"),f=e("./menu"),l=e("./av-events"),c=e("./container-pool"),h={},p=i.handle("av-tokbox-v2");return h.init=function(e,n,i){var a=t.Deferred(),h=o.init(p,e,n,i);return h?(a.reject(h),a.promise()):(h=s.init(),h?(a.reject(h),a.promise()):(f.init(p,n),l.init(p,n),c.init(p,e,n,i),h=u.init(p,n),h?(a.reject(h),a.promise()):(r.bind("framework:perms",d,"av-tokbox-v2"),a.resolve(),a.promise())))},h.start=function(e){return s.start(p,e)},h.info=function(e,t,n){s.info(e,t,n)},h.remote_req=function(e,n,r){var i=t.Deferred();if(n!=="mute"&&n!=="unmute")return i.reject("incorrect data"),i.promise();switch(e){case"microphone":s.manage_publisher(i,"audio",n);break;case"camera":s.manage_publisher(i,"video",n);break;default:i.reject('unrecognized command "'+e+'"')}return i.promise()},h}),require([""]);